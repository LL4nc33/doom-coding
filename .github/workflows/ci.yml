name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint-bash:
    name: Lint Bash Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          # Run shellcheck with exclusions for common false positives:
          # SC2034: Unused variables (often used for color definitions)
          # SC2155: Declare and assign separately (acceptable for readonly)
          # SC1091: Not following sourced files (shellcheck doesn't have context)
          find scripts/ -name "*.sh" -exec shellcheck -e SC2034,SC2155,SC1091 {} +

  lint-go:
    name: Lint Go Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: cmd/doom-tui/go.mod

      - name: Download dependencies
        run: |
          cd cmd/doom-tui
          go mod download
          go mod tidy

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2

      - name: Run golangci-lint
        run: |
          cd cmd/doom-tui
          golangci-lint run ./...

  build:
    name: Build TUI
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin]
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: cmd/doom-tui/go.mod

      - name: Download dependencies
        run: |
          cd cmd/doom-tui
          go mod download
          go mod tidy

      - name: Build
        run: |
          cd cmd/doom-tui
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o doom-tui-${{ matrix.goos }}-${{ matrix.goarch }} .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: doom-tui-${{ matrix.goos }}-${{ matrix.goarch }}
          path: cmd/doom-tui/doom-tui-*

  test-go:
    name: Go Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: cmd/doom-tui/go.mod

      - name: Download dependencies
        run: |
          cd cmd/doom-tui
          go mod download
          go mod tidy

      - name: Run tests
        run: |
          cd cmd/doom-tui
          go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: cmd/doom-tui/coverage.out

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: cmd/doom-tui/go.mod

      - name: Download dependencies
        run: |
          cd cmd/doom-tui
          go mod download
          go mod tidy

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          cd cmd/doom-tui
          govulncheck ./...

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose
        run: |
          docker compose -f docker-compose.yml config --quiet
          docker compose -f docker-compose.lxc.yml config --quiet

  health-check-dry-run:
    name: Health Check Dry Run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Syntax check scripts
        run: |
          for script in scripts/*.sh; do
            echo "Checking $script..."
            bash -n "$script"
          done
